{% extends "layout.html" %}

{% block head %}
  {{ super() }}
  {{ content.head | safe }}
{% endblock %}

{% if meta.get(AssignmentTemplate.LEVELS_DATA.name).meta.type == "assignment" %}
  {% set level_text = "Oppgave" %}
{% elif meta.get(AssignmentTemplate.LEVELS_DATA.name).meta.type == "information" %}
  {% set level_text = "Tema" %}
{% else %}
  {% set level_text = "Level" %}
{% endif %}

{% block header %}
  <div id="meta-container">
    <div id="language-container">
      <button class="snout-button snout-border snout-padding-m">
        <span class="language-flag">{{ current_language.flag }}</span>
        {{ current_language.name }}
      </button>
      <div class="language-dropdown" id="lang-dd">
        {% for lang, val in supported_languages.items() %}
          <a
            data-lang="{{ lang }}"
            {% if github_pages %}
              href="{{ request.path.split('/lang/')[0] }}{{ '/lang/' + lang if lang else '' }}"
            {% else %}
              onclick="document.cookie = 'lang={{ lang }}'; location.reload();"
            {% endif %}
          >
            <span class="language-flag">{{ val.flag }}</span>
            {{ val.name }}
          </a>
        {% endfor %}
      </div>
    </div>

    {%
      set levels = meta
      .get(AssignmentTemplate.LEVELS_DATA.name)
      .data
      .items()
      | sort_by_level
    %}

    {% if levels|length > 1 %}
      <!-- Level Selection Menu -->
      <nav id="level-container">
        {% for link, assignment in levels %}
          {% if current_language.key and current_language.key in assignment.translation_meta %}
            {% set level_meta = assignment.translation_meta[current_language.key] %}
            {% if "/lang/" in request.path %}
              {% set link = request.path.split('/lang/')[0].split('/')[0:-1] | join('/') ~ "/" ~ link ~ "/lang/" ~ current_language.key %}
            {% endif %}
          {% else %}
            {% set level_meta = assignment.meta %}
            {# GitHub Pages only: If a translation doesn't exist for the level, link to the default language #}
            {% if "/lang/" in request.path %}
              {% set link = request.path.split('/lang/')[0].split('/')[0:-1] | join('/') ~ "/" ~ link %}
            {% endif %}
          {% endif %}

          {% if assignment.meta.difficulty %}
            {% set level_difficulty = assignment.meta.difficulty %}
          {% else %}
            {% set level_difficulty = "-1" %}
          {% endif %}

          {% if assignment.level | int == level | int %}
            <!-- Current Level (Non-clickable) -->
            <div class="snout-button snout-border snout-padding-m active level-diff-{{ level_difficulty }}">
              <span> <span class="level-button-text">{{ level_text }}</span> <span class="level-button-number">{{ assignment.level }}</span> </span>
              <!-- Tooltip -->
              <div class="nav-tooltip">
                {% if level_difficulty|int > 0 and level_difficulty|int <= 5 %}
                  <img class="tooltip-diff-image" src="{{ url_for('static', filename='img/difficulties/' +  level_difficulty + '.png') }}">
                {% endif %}
                {{ level_meta.title | unescape }}
              </div>
            </div>
          {% else %}
            <!-- Other Levels (Clickable) -->
            <a
              href="{{ link }}"
              class="snout-button snout-border snout-padding-m level-diff-{{ level_difficulty }}"
            >
              <span class="level-button-text">{{ level_text }}</span> <span class="level-button-number">{{ assignment.level }}</span>
              <!-- Tooltip -->
              <div class="nav-tooltip">
                {% if level_difficulty|int > 0 and level_difficulty|int <= 5 %}
                  <img class="tooltip-diff-image" src="{{ url_for('static', filename='img/difficulties/' +  level_difficulty + '.png') }}">
                {% endif %}
                {{ level_meta.title | unescape }}</div>
            </a>
          {% endif %}
        {% endfor %}
      </nav>
    {% endif %}
  </div>

  <script>
    // Language sorting function
    (function () {
      const container = document.getElementById("lang-dd");

      if (!container) return;

      const preferred = ["", "nno", "eng", "ukr"];
      const rank = new Map(preferred.map((code, i) => [code, i]));
      const BIG = 1e9;

      const links = Array.from(container.querySelectorAll(":scope > a"));

      links.sort((a, b) => {
        const la = a.dataset.lang ?? "";
        const lb = b.dataset.lang ?? "";
        const ra = rank.has(la) ? rank.get(la) : BIG;
        const rb = rank.has(lb) ? rank.get(lb) : BIG;

        if (ra !== rb) return ra - rb;

        return la.localeCompare(lb);
      });

      links.forEach((el) => container.appendChild(el));
    })();
  </script>
  <script>
    function viewportWidth() {
      return window.visualViewport ? window.visualViewport.width : document.documentElement.clientWidth;
    }

    function positionTooltip(tip) {
      const padding = 8;

      tip.style.setProperty("--tooltip-shift", "0px");
      tip.style.setProperty("--arrow-shift", "0px");

      const rect = tip.getBoundingClientRect();
      const vw = viewportWidth();

      const overflowLeft = Math.max(0, padding - rect.left);
      const overflowRight = Math.max(0, rect.right - (vw - padding));

      const shift = overflowLeft - overflowRight;

      if (shift !== 0) {
        tip.style.setProperty("--tooltip-shift", `${shift}px`);
        tip.style.setProperty("--arrow-shift", `${-shift}px`);
      }
    }

    function wireTooltips() {
      const tips = document.querySelectorAll("#level-container .nav-tooltip");
      const updateAll = () => tips.forEach(positionTooltip);

      // Resize handling (mobile address bar / orientation changes)
      window.addEventListener("resize", updateAll, { passive: true });
      window.addEventListener("scroll", updateAll, { passive: true });
      window.addEventListener("orientationchange", updateAll, { passive: true });
      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", updateAll, { passive: true });
        window.visualViewport.addEventListener("scroll", updateAll, { passive: true });
      }

      // Reposition when tooltip content size changes (e.g., image loads)
      const ro = new ResizeObserver(entries => {
        for (const e of entries) positionTooltip(e.target);
      });

      tips.forEach(tip => {
        ro.observe(tip);

        // If there's an image, reposition after it loads too (extra-safe)
        tip.querySelectorAll("img").forEach(img => {
          if (!img.complete) img.addEventListener("load", () => positionTooltip(tip), { once: true });
        });

        const trigger = tip.parentElement;
        if (!trigger) return;

        const updateSoon = () => requestAnimationFrame(() => positionTooltip(tip));

        trigger.addEventListener("pointerenter", updateSoon);
        trigger.addEventListener("pointerdown", updateSoon);
        trigger.addEventListener("click", updateSoon);
        trigger.addEventListener("focusin", updateSoon);

        // iOS Safari sometimes behaves better with touchstart fallback
        trigger.addEventListener("touchstart", updateSoon, { passive: true });
      });

      updateAll();
    }

    wireTooltips();
  </script>
{% endblock %}

{% block base %}
  <h1 class="page-title font-semibold assignment-heading my-6">
    {{ content.heading }}
  </h1>
  {{ content.body | safe }}
{% endblock %}

